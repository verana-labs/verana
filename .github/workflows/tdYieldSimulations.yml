name: 3.TD Yield Simulations

on:
  workflow_dispatch:
    inputs:
      TEST_HARNESS_BRANCH:
        description: 'Branch to use for verana-test-harness checkout (default is main)'
        required: false
        default: 'main'
  pull_request:
    branches:
      - '*' # Trigger on pull requests to any branch
  push:
    branches:
      - '*' # Trigger on every commit to any branch

jobs:
  td-yield-simulations:
    runs-on: ubuntu-latest
    env:
      VERANA_BLOCKCHAIN_PATH: ./verana
      TEST_HARNESS_PATH: ./verana-test-harness
      FEES: 0uvna  # Required for accurate balance tracking in simulations

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ env.VERANA_BLOCKCHAIN_PATH }}

      - name: Checkout verana-test-harness
        uses: actions/checkout@v3
        with:
          repository: verana-labs/verana-test-harness
          ref: ${{ github.event.inputs.TEST_HARNESS_BRANCH || 'v0.9.1-dev.2' }}
          ssh-key: ${{ secrets.VERANA_TEST_HARNESS_DEPLOY_KEY }}
          path: ${{ env.TEST_HARNESS_PATH }}

      - name: Install dependencies
        run: |
          cd ${{ env.VERANA_BLOCKCHAIN_PATH }}
          env
          export PATH=$PATH:$HOME/go/bin
          export BINARYPATH=$HOME/go/bin
          make install
          echo "BINARYPATH=$BINARYPATH" >> $GITHUB_ENV
          type veranad

      - name: Run simulation chain setup asynchronously
        run: |
          cd ${{ env.TEST_HARNESS_PATH }}
          export PATH=$PATH:$BINARYPATH
          echo "Running init_chain_for_simulations.sh..."
          ./scripts/init_chain_for_simulations.sh &
          echo $! > /tmp/init_chain_pid
          echo "Asynchronous chain setup process started with PID: $(cat /tmp/init_chain_pid)"
          echo "Waiting for chain setup process to complete..."

      - name: Wait for chain to be ready
        run: |
          echo "Waiting for chain to start..."
          max_attempts=60
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -s http://localhost:26657/status > /dev/null 2>&1; then
              echo "Chain is ready!"
              break
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts: Chain not ready yet, waiting 2 seconds..."
            sleep 2
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "ERROR: Chain did not start within expected time"
            exit 1
          fi

      - name: Setup accounts for simulations
        run: |
          cd ${{ env.TEST_HARNESS_PATH }}
          export PATH=$PATH:$BINARYPATH
          export FEES=0uvna
          type veranad
          ./scripts/setup_accounts.sh

      - name: Run TD Yield Simulations
        run: |
          cd ${{ env.TEST_HARNESS_PATH }}
          pwd
          find .
          export PATH=$PATH:$BINARYPATH
          export FEES=0uvna
          type veranad
          
          echo "*****************************************************************************************"
          echo "********************* Running TD Yield Simulation - Journey 20 ************************"
          echo "********************* (Setup Funding Proposal) ****************************************"
          echo "*****************************************************************************************"
          go run cmd/main.go 20
          
          echo "*****************************************************************************************"
          echo "********************* Running TD Yield Simulation - Journey 21 ************************"
          echo "********************* (Sufficient Funding Scenario) ***********************************"
          echo "*****************************************************************************************"
          go run cmd/main.go 21
          
          echo "*****************************************************************************************"
          echo "********************* Running TD Yield Simulation - Journey 22 ************************"
          echo "********************* (Insufficient Funding Scenario) **********************************"
          echo "*****************************************************************************************"
          go run cmd/main.go 22

      - name: Kill asynchronous chain setup process
        run: |
          if [ -f /tmp/init_chain_pid ]; then
            kill -9 $(cat /tmp/init_chain_pid) || true
            rm /tmp/init_chain_pid
          fi
          # Also kill any veranad processes
          pkill -9 veranad || true

      - name: Finalize without error
        run: echo "TD Yield Simulations execution completed successfully."

