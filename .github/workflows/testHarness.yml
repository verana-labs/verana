name: 2.Test Harness Execution

on:
  workflow_dispatch:
  pull_request:
    branches:
      - '*' # Trigger on pull requests to any branch
  push:
    branches:
      - '*' # Trigger on every commit to any branch

jobs:
  test-harness:
    runs-on: ubuntu-latest
    env:
      TEST_HARNESS_PATH: ./testharness

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Build canonical image
        run: |
          docker build \
            -f docker/veranad.Dockerfile \
            --build-arg INCLUDE_GO=true \
            -t verana-node:ci .

      - name: Run test harness in canonical image
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -w /workspace \
            -e TEST_HARNESS_PATH \
            verana-node:ci \
            /bin/bash -lc 'set -e
              echo ./scripts/setup_primary_validator.sh....
              ./scripts/setup_primary_validator.sh &
              PID=$!
              echo "Asynchronous setup process started with PID: $PID"
              cd $TEST_HARNESS_PATH
              ./scripts/setup_accounts.sh
              ./scripts/run_all.sh
              kill -9 $PID || true
            '

      - name: Finalize without error
        run: echo "Test harness execution completed successfully."
