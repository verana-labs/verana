name: 2.Test Harness Execution

on:
  pull_request:
    branches:
      - '*' # Trigger on pull requests to any branch
  push:
    branches:
      - '*' # Trigger on every commit to any branch

jobs:
  test-harness:
    runs-on: ubuntu-latest
    env:
      VERANA_BLOCKCHAIN_PATH: ./verana-blockchain
      TEST_HARNESS_PATH: ./verana-test-harness
      VERANA_TEST_HARNESS_CODE_REPO_KEY: ${{ secrets.VERANA_TEST_HARNESS_DEPLOY_KEY }}

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ env.VERANA_BLOCKCHAIN_PATH }}

      - name: Set up SSH for accessing the selected repository
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.VERANA_TEST_HARNESS_CODE_REPO_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Checkout Dockerfiles from verana-deploy
        uses: actions/checkout@v3
        with:
          repository: verana-labs/verana-test-harness
          ref: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ env.TEST_HARNESS_PATH }}

      - name: Install dependencies and run setup script asynchronously
        run: |
          cd ${{ env.VERANA_BLOCKCHAIN_PATH }}
          make install
          ./scripts/setup_primary_validator.sh &
          echo $! > /tmp/setup_primary_validator_pid

      - name: Run test harness
        run: |
          cd ${{ env.TEST_HARNESS_PATH }}
          ./script/run_all.sh

      - name: Kill asynchronous setup process
        run: |
          if [ -f /tmp/setup_primary_validator_pid ]; then
            kill -9 $(cat /tmp/setup_primary_validator_pid) || true
            rm /tmp/setup_primary_validator_pid
          fi

      - name: Finalize without error
        run: echo "Test harness execution completed successfully."
