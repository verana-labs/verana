name: 2.Test Harness Execution

on:
  workflow_dispatch:
  pull_request:
    branches:
      - '*' # Trigger on pull requests to any branch
  push:
    branches:
      - '*' # Trigger on every commit to any branch

jobs:
  test-harness:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    env:
      TEST_HARNESS_PATH: ./testharness
      HARNESS_MODE: k8s

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Determine harness mode
        run: |
          if [ "$HARNESS_MODE" = "k8s" ]; then
            if [ -n "${K8S_RPC_ENDPOINT:-}" ]; then
              echo "HARNESS_MODE_EFFECTIVE=k8s" >> $GITHUB_ENV
            else
              echo "HARNESS_MODE_EFFECTIVE=docker" >> $GITHUB_ENV
              echo "K8S mode requested but K8S_RPC_ENDPOINT is empty; falling back to docker." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "HARNESS_MODE_EFFECTIVE=docker" >> $GITHUB_ENV
          fi
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            PR_NUMBER=$(echo "$GITHUB_REF" | awk -F'/' '{print $3}')
            echo "IMAGE_TAG=ghcr.io/verana-labs/verana-node:pr-${PR_NUMBER}" >> $GITHUB_ENV
          else
            BRANCH_REF="${GITHUB_REF_NAME:-$GITHUB_REF}"
            BRANCH_TAG="${BRANCH_REF//\//-}"
            echo "IMAGE_TAG=ghcr.io/verana-labs/verana-node:branch-${BRANCH_TAG}" >> $GITHUB_ENV
          fi

      - name: Login to GHCR
        if: env.HARNESS_MODE_EFFECTIVE == 'docker'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build canonical image
        if: env.HARNESS_MODE_EFFECTIVE == 'docker'
        run: |
          echo "Pulling $IMAGE_TAG"
          attempts=0
          max_attempts=30
          until docker pull "$IMAGE_TAG"; do
            attempts=$((attempts + 1))
            if [ "$attempts" -ge "$max_attempts" ]; then
              echo "Failed to pull $IMAGE_TAG after $attempts attempts." >&2
              exit 1
            fi
            echo "Image not ready yet, retrying in 20s... ($attempts/$max_attempts)"
            sleep 20
          done
          docker tag "$IMAGE_TAG" verana-node:ci

      - name: Run test harness in canonical image
        if: env.HARNESS_MODE_EFFECTIVE == 'docker'
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -w /workspace \
            -e TEST_HARNESS_PATH \
            verana-node:ci \
            /bin/bash -lc 'set -e
              if ! command -v go >/dev/null 2>&1; then
                apt-get update && apt-get install -y golang && rm -rf /var/lib/apt/lists/*
              fi
              echo ./scripts/setup_primary_validator.sh....
              ./scripts/setup_primary_validator.sh &
              PID=$!
              echo "Asynchronous setup process started with PID: $PID"
              cd $TEST_HARNESS_PATH
              ./scripts/setup_accounts.sh
              ./scripts/run_all.sh
              kill -9 $PID || true
            '

      - name: Run test harness against K8s
        if: env.HARNESS_MODE_EFFECTIVE == 'k8s'
        run: |
          echo "Running test harness against K8s endpoints"
          echo "K8S_RPC_ENDPOINT=$K8S_RPC_ENDPOINT"
          echo "K8S_LCD_ENDPOINT=$K8S_LCD_ENDPOINT"
          cd ${{ env.TEST_HARNESS_PATH }}
          export VERANA_RPC_ENDPOINT="${K8S_RPC_ENDPOINT}"
          export VERANA_LCD_ENDPOINT="${K8S_LCD_ENDPOINT}"
          ./scripts/setup_accounts.sh
          ./scripts/run_all.sh

      - name: Finalize without error
        run: echo "Test harness execution completed successfully."
